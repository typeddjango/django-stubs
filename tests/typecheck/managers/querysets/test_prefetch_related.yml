-   case: prefetch_related_to_attr
    main: |
        from myapp.models import Article, Tag
        from django.db.models import Prefetch, F, QuerySet
        from django.db import models
        from typing_extensions import Literal, TypedDict
        from django_stubs_ext import WithAnnotations

        ### Noop (to_attr not provided)
        reveal_type(Article.objects.prefetch_related(Prefetch("tags")).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article, myapp.models.Article]"
        reveal_type(Article.objects.prefetch_related(Prefetch("tags", Tag.objects.all())).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article, myapp.models.Article]"
        reveal_type(Prefetch("tags")) # N: Revealed type is "django.db.models.query.Prefetch[django.db.models.query.QuerySet[django.db.models.base.Model, django.db.models.base.Model], builtins.str]"
        reveal_type(Prefetch("tags", Tag.objects.all())) # N: Revealed type is "django.db.models.query.Prefetch[django.db.models.query.QuerySet[myapp.models.Tag, myapp.models.Tag], builtins.str]"

        # Prefetch created in a function with no to_attr
        def get_prefetch_no_to_attr() -> Prefetch[QuerySet[Tag]]:
            return Prefetch("tags", Tag.objects.all())

        reveal_type(Article.objects.prefetch_related(get_prefetch_no_to_attr()).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article, myapp.models.Article]"

        # Prefetch created in a function with no to_attr and no queryset
        def get_prefetch_no_to_attr_no_qs() -> Prefetch:
            return Prefetch("tags")

        reveal_type(Article.objects.prefetch_related(get_prefetch_no_to_attr_no_qs()).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article, myapp.models.Article]"

        # On the QuerySet
        article_qs = Article.objects.all().prefetch_related(Prefetch("tags", Tag.objects.all(), to_attr="every_tags"))
        reveal_type(article_qs) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"
        reveal_type(article_qs.get().every_tags) # N: Revealed type is "builtins.list[myapp.models.Tag]"
        reveal_type(
            Tag.objects.all().prefetch_related( # N: Revealed type is "builtins.list[myapp.models.Article]"
                Prefetch("article_set", Article.objects.all(), to_attr="every_articles")
            ).get().every_articles
        )

        # On the Manager
        reveal_type(
            Article.objects.prefetch_related( # N: Revealed type is "builtins.list[myapp.models.Tag]"
                Prefetch("tags", Tag.objects.all(), to_attr="every_tags")
            ).get().every_tags
        )
        reveal_type(
            Tag.objects.prefetch_related( # N: Revealed type is "builtins.list[myapp.models.Article]"
                Prefetch("article_set", Article.objects.all(), to_attr="every_articles")
            ).get().every_articles
        )

        # Member expr
        reveal_type(
            Article.objects.prefetch_related( # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"
                models.Prefetch("tags", Tag.objects.all(), to_attr="every_tags")
            ).all()
        )
        # pos args only
        reveal_type(
            Article.objects.prefetch_related( # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"
                models.Prefetch("tags", Tag.objects.all(), "every_tags")
            ).all()
        )

        # Multiple Prefetch items: both `to_attr` annotations should be present
        multi_qs = Article.objects.all().prefetch_related(
            Prefetch("tags", Tag.objects.all(), to_attr="ts"),
            Prefetch("tags", Tag.objects.all(), to_attr="ts2"),
        )
        reveal_type(multi_qs) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'ts': builtins.list[myapp.models.Tag], 'ts2': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'ts': builtins.list[myapp.models.Tag], 'ts2': builtins.list[myapp.models.Tag]})]]"
        reveal_type(multi_qs.get().ts) # N: Revealed type is "builtins.list[myapp.models.Tag]"
        reveal_type(multi_qs.get().ts2) # N: Revealed type is "builtins.list[myapp.models.Tag]"

        # Mixed inline `Prefetch` and plain lookup string in one call; string should be ignored
        mixed_plain = Article.objects.prefetch_related(
            "article_set",
            Prefetch("article_set", Article.objects.all(), to_attr="arts3"),
        )
        reveal_type(mixed_plain) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'arts3': builtins.list[myapp.models.Article]})], myapp.models.Article@AnnotatedWith[TypedDict({'arts3': builtins.list[myapp.models.Article]})]]"

        # Intermediary variable -- function scope
        def foo() -> None:
            tag_prefetch = Prefetch("tags", Tag.objects.all(), to_attr="every_tags")
            reveal_type(Article.objects.prefetch_related(tag_prefetch).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"

        # Intermediary variable -- module scope
        tag_prefetch = Prefetch("tags", Tag.objects.all(), to_attr="every_tags")
        reveal_type(Article.objects.prefetch_related(tag_prefetch).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"

        # Prefetch created in a function
        def get_invalid_prefetch() -> Prefetch[QuerySet[Tag], Literal["every_tags"]]:
            return Prefetch("tags", Tag.objects.all(), to_attr="foo") # E: Incompatible return value type (got "Prefetch[QuerySet[Tag, Tag], Literal['foo']]", expected "Prefetch[QuerySet[Tag, Tag], Literal['every_tags']]")  [return-value] # E: Argument "to_attr" to "Prefetch" has incompatible type "Literal['foo']"; expected "Literal['every_tags'] | None"  [arg-type]

        def get_prefetch() -> Prefetch[QuerySet[Tag], Literal["every_tags"]]:
            return Prefetch("tags", Tag.objects.all(), to_attr="every_tags")

        reveal_type(Article.objects.prefetch_related(get_prefetch()).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"

        # Prefetch created in a function with to_attr as an intermediary variable
        def get_prefetch_with_var() -> Prefetch[QuerySet[Tag], Literal["every_tags"]]:
            to_attr = "every_tags" # TODO: RM error next line
            return Prefetch("tags", Tag.objects.all(), to_attr) # E: Argument 3 to "Prefetch" has incompatible type "str"; expected "Literal['every_tags'] | None"  [arg-type]

        reveal_type(Article.objects.prefetch_related(get_prefetch_with_var()).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag]})]]"

        # Mixed inline `Prefetch` and variable `Prefetch` in one call
        mixed_qs = Article.objects.prefetch_related(
            tag_prefetch,
            Prefetch("article_set", Article.objects.all(), to_attr="arts2"),
        )
        reveal_type(mixed_qs) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag], 'arts2': builtins.list[myapp.models.Article]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag], 'arts2': builtins.list[myapp.models.Article]})]]"

        # Prefetch with `to_attr` arg but without the `queryset` arg
        reveal_type(Article.objects.prefetch_related(models.Prefetch("tags", to_attr="just_tags")).get().just_tags) # N: Revealed type is "builtins.list[myapp.models.Tag]"

        # Prefetch with annotated `queryset`
        reveal_type(Article.objects.prefetch_related( # N: Revealed type is "builtins.list[myapp.models.Tag@AnnotatedWith[TypedDict({'foo': Any})]]"
            models.Prefetch("tags", Tag.objects.annotate(foo=F("id")).all(), to_attr="just_tags")).get().just_tags
        )

        class MyDict(TypedDict):
            foo: str

        def get_prefetch_with_annotations() -> Prefetch[QuerySet[WithAnnotations[Tag, MyDict]], Literal["every_tags"]]:
            return Prefetch("tags", Tag.objects.annotate(foo=F("id")), "every_tags")

        reveal_type(Article.objects.prefetch_related(get_prefetch_with_annotations()).all()) # N: Revealed type is "django.db.models.query.QuerySet[myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag@AnnotatedWith[TypedDict('main.MyDict', {'foo': builtins.str})]]})], myapp.models.Article@AnnotatedWith[TypedDict({'every_tags': builtins.list[myapp.models.Tag@AnnotatedWith[TypedDict('main.MyDict', {'foo': builtins.str})]]})]]"
        reveal_type(Article.objects.prefetch_related(get_prefetch_with_annotations()).get().every_tags[0].foo) # N: Revealed type is "builtins.str"
    installed_apps:
        - myapp
    files:
        -   path: myapp/__init__.py
        -   path: myapp/models.py
            content: |
                from django.db import models

                class Tag(models.Model): ...
                class Article(models.Model):
                    tags = models.ManyToManyField(to=Tag, related_name="articles", blank=True)

-   case: prefetch_related_and_annotate
    main: |
        from django.db.models import Prefetch, F
        from django.contrib.auth.models import User, Group

        user = (
            User.objects
            .annotate(annotated_user=F("username"))
            .prefetch_related(Prefetch("groups", Group.objects.all(), to_attr="to_attr_groups"))
            .get()
        )
        reveal_type(user.annotated_user) # N: Revealed type is "Any"
        reveal_type(user.to_attr_groups) # N: Revealed type is "builtins.list[django.contrib.auth.models.Group]"

    installed_apps:
        - django.contrib.auth

-   case: prefetch_related_conflict_with_annotate
    main: |
        from django.db.models import Prefetch, F
        from django.contrib.auth.models import User, Group

        # When mixing `.annotate(foo=...)` and `prefetch_related(Prefetch(...,to_attr=foo))`
        # The last annotate in the chain takes precedence (even if it is prior to the prefetch_related)
        annotate_into_prefetch = (
            User.objects
            .annotate(foo=F("username"))
            .prefetch_related(Prefetch("groups", Group.objects.all(), to_attr="foo"))
            .get().foo
        )
        reveal_type(annotate_into_prefetch)  # N: Revealed type is "Any"
        prefetch_into_annotate = (
            User.objects
            .prefetch_related(Prefetch("groups", Group.objects.all(), to_attr="foo"))
            .annotate(foo=F("username"))
            .get().foo
        )
        reveal_type(prefetch_into_annotate)  # N: Revealed type is "Any"
